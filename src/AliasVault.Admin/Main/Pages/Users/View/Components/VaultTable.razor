@using AliasVault.RazorComponents.Tables

<SortableTable Columns="@_vaultTableColumns" SortColumn="@SortColumn" SortDirection="@SortDirection" OnSortChanged="HandleSortChanged">
    @foreach (var entry in SortedVaultList)
    {
        <SortableTableRow>
            <SortableTableColumn IsPrimary="true">@entry.Id</SortableTableColumn>
            <SortableTableColumn>@entry.CreatedAt.ToString("yyyy-MM-dd HH:mm")</SortableTableColumn>
            <SortableTableColumn>@entry.UpdatedAt.ToString("yyyy-MM-dd HH:mm")</SortableTableColumn>
            <SortableTableColumn>@Math.Round((double)entry.FileSize / 1024, 1) MB</SortableTableColumn>
            <SortableTableColumn>@entry.Version</SortableTableColumn>
            <SortableTableColumn>@entry.RevisionNumber</SortableTableColumn>
            <SortableTableColumn>@entry.CredentialsCount</SortableTableColumn>
            <SortableTableColumn>@entry.EmailClaimsCount</SortableTableColumn>
            <SortableTableColumn>
                @if (entry == LatestVault)
                {
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">Current</span>
                }
                @if (_previousEntry != null && HasPasswordChanged(entry, _previousEntry))
                {
                    <span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Password Changed</span>
                }
            </SortableTableColumn>
            <SortableTableColumn>
                @if (entry != LatestVault)
                {
                    <Button OnClick="() => MakeCurrentAsync(entry)">Restore</Button>
                }
            </SortableTableColumn>
        </SortableTableRow>
        _previousEntry = entry;
    }
</SortableTable>

@code {
    /// <summary>
    /// Gets or sets the list of vaults to display.
    /// </summary>
    [Parameter]
    public List<Vault> VaultList { get; set; } = new();

    /// <summary>
    /// Gets or sets the event callback to make a vault current.
    /// </summary>
    [Parameter]
    public EventCallback<Vault> OnMakeCurrent { get; set; }

    private string SortColumn { get; set; } = "UpdatedAt";
    private SortDirection SortDirection { get; set; } = SortDirection.Descending;
    private Vault? _previousEntry;

    private readonly List<TableColumn> _vaultTableColumns = [
        new TableColumn { Title = "ID", PropertyName = "Id" },
        new TableColumn { Title = "Created", PropertyName = "CreatedAt" },
        new TableColumn { Title = "Updated", PropertyName = "UpdatedAt" },
        new TableColumn { Title = "Filesize", PropertyName = "FileSize" },
        new TableColumn { Title = "DB version", PropertyName = "Version" },
        new TableColumn { Title = "Revision", PropertyName = "RevisionNumber" },
        new TableColumn { Title = "Credentials", PropertyName = "CredentialsCount" },
        new TableColumn { Title = "Email Claims", PropertyName = "EmailClaimsCount" },
        new TableColumn { Title = "Status", Sortable = false },
        new TableColumn { Title = "Actions", Sortable = false },
    ];

    private IEnumerable<Vault> SortedVaultList => SortList(VaultList, SortColumn, SortDirection);

    private Vault? LatestVault => VaultList.MaxBy(v => v.RevisionNumber);

    private void HandleSortChanged((string column, SortDirection direction) sort)
    {
        SortColumn = sort.column;
        SortDirection = sort.direction;
        StateHasChanged();
    }

    private IEnumerable<Vault> SortList(List<Vault> vaults, string sortColumn, SortDirection sortDirection)
    {
        return sortColumn switch
        {
            "Id" => SortProperty(vaults, v => v.Id, sortDirection),
            "CreatedAt" => SortProperty(vaults, v => v.CreatedAt, sortDirection),
            "UpdatedAt" => SortProperty(vaults, v => v.UpdatedAt, sortDirection),
            "FileSize" => SortProperty(vaults, v => v.FileSize, sortDirection),
            "Version" => SortProperty(vaults, v => v.Version, sortDirection),
            "RevisionNumber" => SortProperty(vaults, v => v.RevisionNumber, sortDirection),
            "CredentialsCount" => SortProperty(vaults, v => v.CredentialsCount, sortDirection),
            "EmailClaimsCount" => SortProperty(vaults, v => v.EmailClaimsCount, sortDirection),
            _ => vaults
        };
    }

    private IEnumerable<T> SortProperty<T, TKey>(IEnumerable<T> source, Func<T, TKey> keySelector, SortDirection direction)
    {
        return direction == SortDirection.Ascending
            ? source.OrderBy(keySelector)
            : source.OrderByDescending(keySelector);
    }

    private static bool HasPasswordChanged(Vault current, Vault previous)
    {
        return current.Salt != previous.Salt || current.Verifier != previous.Verifier;
    }

    private async Task MakeCurrentAsync(Vault vault)
    {
        await OnMakeCurrent.InvokeAsync(vault);
    }
}
