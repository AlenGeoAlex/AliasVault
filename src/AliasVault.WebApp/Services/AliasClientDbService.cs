//-----------------------------------------------------------------------
// <copyright file="AliasClientDbService.cs" company="lanedirt">
// Copyright (c) lanedirt. All rights reserved.
// Licensed under the MIT license. See LICENSE.md file in the project root for full license information.
// </copyright>
//-----------------------------------------------------------------------

namespace AliasVault.WebApp.Services;

using AliasClientDb;
using AliasVault.WebApp.Auth.Services;
using Microsoft.Data.Sqlite;
using Microsoft.EntityFrameworkCore;
using Microsoft.JSInterop;

/// <summary>
/// Class to manage the in-memory AliasClientDb service. The reason for this service is to provide a way to interact
/// with a AliasClientDb database instance that is only persisted in memory due to the encryption requirements of the
/// database itself. The database should not be persisted to disk when in un-encrypted form.
/// </summary>
public class AliasClientDbService
{
    private AliasClientDbContext _dbContext;
    private AuthService _authService;
    private IJSRuntime _jsRuntime;

    /// <summary>
    /// Initializes a new instance of the <see cref="AliasClientDbService"/> class.
    /// </summary>
    /// <param name="authService">AuthService.</param>
    /// <param name="jsRuntime">IJSRuntime.</param>
    public AliasClientDbService(AuthService authService, IJSRuntime jsRuntime)
    {
        _authService = authService;
        _jsRuntime = jsRuntime;

        // Create a new in-memory database.
        string connectionString = "Data Source=AliasClientDb.sqlite";

        // TODO: why doesn't :memory: work? Is the file above still secure?

        // string connectionString = "Data Source=:memory:";
        using var connection = new SqliteConnection(connectionString);
        connection.Open();

        var options = new DbContextOptionsBuilder<AliasClientDbContext>()
            .UseSqlite(connection)
            .Options;

        _dbContext = new AliasClientDbContext(options);

        // Ensure the database is created.
        _dbContext.Database.EnsureCreated();
    }

    /// <summary>
    /// Saves the database to an encrypted string.
    /// </summary>
    /// <returns>Encrypted string.</returns>
    public async Task<string> SaveDatabaseAsync()
    {
        using var memoryStream = new MemoryStream();
        using var connection = new SqliteConnection(_dbContext.Database.GetDbConnection().ConnectionString);
        await connection.OpenAsync();
        using var command = connection.CreateCommand();
        command.CommandText = "VACUUM main INTO @fileName";

        var tempFileName = Path.GetTempFileName();
        command.Parameters.Add(new SqliteParameter("@fileName", tempFileName));
        await command.ExecuteNonQueryAsync();

        var bytes = await File.ReadAllBytesAsync(tempFileName);

        string base64String = Convert.ToBase64String(bytes);
        File.Delete(tempFileName);

        // Encrypt base64 string.
        // Encrypt using IJSInterop
        Console.WriteLine("Encrypted using key: " + _authService.GetEncryptionKeyAsBase64Async());
        string encryptedBase64String = await _jsRuntime.InvokeAsync<string>("cryptoInterop.encrypt", base64String, _authService.GetEncryptionKeyAsBase64Async());

        // Decrypt it again
        string decryptedBase64String = await _jsRuntime.InvokeAsync<string>("cryptoInterop.decrypt", encryptedBase64String, _authService.GetEncryptionKeyAsBase64Async());

        // Print original, encrypted and decrypted sting to console
        Console.WriteLine("Original: " + base64String);
        Console.WriteLine("Encrypted: " + encryptedBase64String);
        Console.WriteLine("Decrypted: " + decryptedBase64String);

        return encryptedBase64String;
    }

    /// <summary>
    /// Returns the AliasClientDbContext instance.
    /// </summary>
    /// <returns>AliasClientDbContext.</returns>
    public AliasClientDbContext GetDbContext()
    {
        return _dbContext;
    }

    /// <summary>
    /// Loads the database from an encrypted string.
    /// </summary>
    /// <returns>Task.</returns>
    public async Task LoadFromEncryptedString()
    {
        var base64String = "U1FMaXRlIGZvcm1hdCAzABAAAQEAQCAgAAAAAQAAAAUAAAAAAAAAAAAAAAIAAAAEAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAC52iQ0P+AACDvUADvUPxQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIFNAQcXHx8Bgml0YWJsZVBhc3N3b3Jkc1Bhc3N3b3JkcwJDUkVBVEUgVEFCTEUgIlBhc3N3b3JkcyIgKAogICAgIklkIiBURVhUIE5PVCBOVUxMIENPTlNUUkFJTlQgIlBLX1Bhc3N3b3JkcyIgUFJJTUFSWSBLRVksCiAgICAiVmFsdWUiIFRFWFQgTlVMTCwKICAgICJDcmVhdGVkQXQiIFRFWFQgTk9UIE5VTEwsCiAgICAiVXBkYXRlZEF0IiBURVhUIE5PVCBOVUxMCikxAgYXRR8BAGluZGV4c3FsaXRlX2F1dG9pbmRleF9QYXNzd29yZHNfMVBhc3N3b3JkcwMAAAAIAAAAAAUAAAABD/sAAAAABQ/7DkQN1Q1mDPcMiAwZC6oLOwrMCl0J7gmACREIoggzB8QHVQbmBncGCAWZBSoEuwRMA90DbwMAApECIwG0AUUA1gBnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABtJAVVQTszRDZFMzU1QjItM0Y3NC00MDNCLUE1NUMtNTVBMDFDMTAzREQ1VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjEwLjc1NjAwMDEtMDEtMDEgMDA6MDA6MDBtIwVVQTszQTk0RkQ4OUMtMjEzNS00MTdGLUFBMzYtMEIxMUVFQzAzMTY2VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjEwLjU1OTAwMDEtMDEtMDEgMDA6MDA6MDBtIgVVQTszQzlENDM4QkMtOEM1Ny00MTFELTlFRjAtOEQwRURGNjc2MjdGVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjEwLjM4MTAwMDEtMDEtMDEgMDA6MDA6MDBtIQVVQTszNzNCOTY3MUItRTNFNi00QjRDLUFGMTgtQjcyMkUwRTkyNjRDVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjEwLjIwODAwMDEtMDEtMDEgMDA6MDA6MDBsIAVVQTkzNDY5QjUzMjgtODM0OC00MEY1LUE1MTgtMjIxNTI3RjQ5NEU3VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjEwLjAyMDAwMS0wMS0wMSAwMDowMDowMG0fBVVBOzMyQjM2NUJDMy0wOTkyLTRDRDUtOEFCOS0zRTg4MTM0QjFEMjFUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDkuODU3MDAwMS0wMS0wMSAwMDowMDowMG0eBVVBOzM2OEY3NzlGNi0yMDAyLTRFOTEtQkU3NS01RkNCQUY1MzU5MzFUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDkuNjY5MDAwMS0wMS0wMSAwMDowMDowMGwdBVVBOTNCN0IxNDMyRC1FQzUzLTQxMUYtOTM0OC0zRkEzMTY1QjcyRTJUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDkuNDkwMDAxLTAxLTAxIDAwOjAwOjAwbRwFVUE7MzQ5ODA4REU5LTRBMTYtNEJEMS04NjczLTE0RkE4N0YwNzJDOFRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNy41MjkwMDAxLTAxLTAxIDAwOjAwOjAwbRsFVUE7MzNFMkZBQTk3LTg0RjItNENCRi04Q0Y3LURCNzU1MUIyOUFEN1Rlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNy4zNTYwMDAxLTAxLTAxIDAwOjAwOjAwbRoFVUE7M0NFQUZGQjVFLTNCNzAtNDYzNi04OERCLUIzNzY2OTZGMTM0RlRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNy4yMDgwMDAxLTAxLTAxIDAwOjAwOjAwbRkFVUE7MzQ5QURBOTU4LUREMEYtNEZENC05QTk4LTYxNjc1MzdENDM0OFRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNy4wNTEwMDAxLTAxLTAxIDAwOjAwOjAwbRgFVUE7Mzg4RDk5OTFDLTVFMjMtNDI0NS05QjgzLUU2N0FBNjQ2QUI2RFRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNi44NzIwMDAxLTAxLTAxIDAwOjAwOjAwbRcFVUE7Mzk5RDY0ODJGLTVDOUQtNEVDMC05QzJELTRFNTI0Njk0QjZGMVRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNi43MjIwMDAxLTAxLTAxIDAwOjAwOjAwbRYFVUE7M0IxOEQ5NjI0LTYyMTgtNDlDRS04ODlCLURCRTk4MUU1OEE1OVRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNi41MTkwMDAxLTAxLTAxIDAwOjAwOjAwbRUFVUE7MzI3MTc0QTgwLTJCMUQtNEEzOS1COTNCLUFEMUFBQjkwOUUzN1Rlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNi4zNTMwMDAxLTAxLTAxIDAwOjAwOjAwbRQFVUE7M0U5MTE3N0E4LTU4NTgtNEM0QS04Q0QwLUE1QzYzNEZENERCMlRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNi4xNTkwMDAxLTAxLTAxIDAwOjAwOjAwbRMFVUE7MzQ5QjNGN0ExLUMzNTgtNDUxNi1CMDkxLUNEQkREMTBFQUZEOVRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNS45NzEwMDAxLTAxLTAxIDAwOjAwOjAwbRIFVUE7M0JBRjNCNzg1LTNGOTYtNDFEMC05OTczLTA3RUZFREJDNEZDRFRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNS44MjIwMDAxLTAxLTAxIDAwOjAwOjAwbREFVUE7MzU0MEE2RTFFLTdENzctNEY4OC04RjQ0LTExOTVFNTEzM0I5N1Rlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNS42MjcwMDAxLTAxLTAxIDAwOjAwOjAwbRAFVUE7M0ZBOTE2NDU2LTI5NTItNDY5Ri05NDk4LUNBMzc3QzJEQkU1NlRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNS40NDQwMDAxLTAxLTAxIDAwOjAwOjAwbA8FVUE5MzEwMEFBNTQyLUJFRDUtNDBBQS1BQzI0LUVBREZEM0I5RTMyMlRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowNS4yNzAwMDEtMDEtMDEgMDA6MDA6MDBtDgVVQTszQzc4M0VGMUItRkZEQy00N0Q2LUIyRDctQ0ZFQjk5QTBENzU1VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA1LjA5OTAwMDEtMDEtMDEgMDA6MDA6MDBtDQVVQTszNDQzMTE2N0YtNDhCMC00Rjk3LTkxNTItMUY5MEQ0OTlFNTAyVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA0LjkyODAwMDEtMDEtMDEgMDA6MDA6MDBtDAVVQTszOUVFNDkwOUEtQkI5MC00Njk0LTk3RkUtQUFBNjhGMzdDQUY4VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA0Ljc2NDAwMDEtMDEtMDEgMDA6MDA6MDBtCwVVQTszMERFNzMyNjItNjZCNy00RUEzLTgzNUMtMzM2QzRBQ0JDNzk0VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA0LjU5MjAwMDEtMDEtMDEgMDA6MDA6MDBtCgVVQTszRDYxRDhENTUtMzBDNi00RDkyLTk0MkItREREMzMxRkYyRkQzVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA0LjQzMzAwMDEtMDEtMDEgMDA6MDA6MDBtCQVVQTszNEMxRThFMjktMDNEMi00M0FFLTkxMDMtODRCMEQwNTBEQUIzVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA0LjI2ODAwMDEtMDEtMDEgMDA6MDA6MDBtCAVVQTszNDhGODZFRTItOTE2MS00OTU5LThFQ0UtQTNFODUzNDdGOUY3VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA0LjA5ODAwMDEtMDEtMDEgMDA6MDA6MDBtBwVVQTszOUM4RUIyQTQtQTE4Mi00NjMxLUEwNzItNjEwQUM2QTU0Rjg1VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjAzLjkzMTAwMDEtMDEtMDEgMDA6MDA6MDBtBgVVQTszQzIyNTVGMDQtRjRGOC00NDQ2LUIyNEQtOTMyREJGMzhGNkY5VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjAzLjc3MjAwMDEtMDEtMDEgMDA6MDA6MDBtBQVVQTszNTY5Njg5NEUtRDU5Qi00QUZBLUFGMEEtNDk4RDYwMjY5NTE5VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjAxLjQ2NDAwMDEtMDEtMDEgMDA6MDA6MDBtBAVVQTszMzA0RkJENzQtNDU4Ni00NDdELUJDNDYtNTI4RTQ1OEEzODdFVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjAxLjI4MjAwMDEtMDEtMDEgMDA6MDA6MDBtAwVVQTszRjAyMDQwRkYtNkM0Qy00QkVDLUFEMDYtODk3OEQ4MDI4QUU0VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjAwLjk0ODAwMDEtMDEtMDEgMDA6MDA6MDBtAgVVQTszMjA1NkMzOTctQTc5Mi00RjgyLTk2NzgtOUI1RDZBNkI0ODU0VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjAwLjU5MjAwMDEtMDEtMDEgMDA6MDA6MDBtAQVVQTszQzc1Nzc2RUYtRTQx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Qzg3MTNFNUNGRD0oA1UBRDZFMzU1QjItM0Y3NC00MDNCLUE1NUMtNTVBMDFDMTAzREQ1JCgDVQFENjFEOEQ1NS0zMEM2LTREOTItOTQyQi1EREQzMzFGRjJGRDMKKANVAUQ1NDQyMTExLTYzMzItNDA0My04N0FDLTRDRkFBMzY5NTc4MjIoA1UBQ0VBRkZCNUUtM0I3MC00NjM2LTg4REItQjM3NjY5NkYxMzRGGigDVQFDOUQ0MzhCQy04QzU3LTQxMUQtOUVGMC04RDBFREY2NzYyN0YiKANVAUM3ODNFRjFCLUZGREMtNDdENi1CMkQ3LUNGRUI5OUEwRDc1NQ4nA1UJQzc1Nzc2RUYtRTQxNC00NEU5LTg1MUYtNzlENEI0NEJGNUIzKANVAUMyMjU1RjA0LUY0RjgtNDQ0Ni1CMjRELTkzMkRCRjM4RjZGOQYoA1UBQkFGM0I3ODUtM0Y5Ni00MUQwLTk5NzMtMDdFRkVEQkM0RkNEEigDVQFCN0IxNDMyRC1FQzUzLTQxMUYtOTM0OC0zRkEzMTY1QjcyRTIdKANVAUIxOEQ5NjI0LTYyMTgtNDlDRS04ODlCLURCRTk4MUU1OEE1ORYoA1UBQTk0RkQ4OUMtMjEzNS00MTdGLUFBMzYtMEIxMUVFQzAzMTY2IygDVQFBMjkyOERENS0yQkI5LTRDQ0MtOEYwQy1FNkQ1QTkyRkNBMTVAKANVATlFRTQ5MDlBLUJCOTAtNDY5NC05N0ZFLUFBQTY4RjM3Q0FGOAwoA1UBOUM4RUIyQTQtQTE4Mi00NjMxLUEwNzItNjEwQUM2QTU0Rjg1BygDVQE5OUQ2NDgyRi01QzlELTRFQzAtOUMyRC00RTUyNDY5NEI2RjEXKANVATk4NEFENzc1LTM0MTctNEMwQy05REJELTk2NDEwMjE3NkRDNkIoA1UBOEE1NjgzNzItRjBGMC00RTAxLUFGRTEtRTY1MjlCNUU5RTA0KygDVQE4OEQ5OTkxQy01RTIzLTQyNDUtOUI4My1FNjdBQTY0NkFCNkQYKANVATgxQzBGQ0I2LTlFQjgtNEIzNy1BRjhDLTQ0M0YwODYwNzlGRiwoA1UBNzlDRUIzRDAtREE0QS00MEYyLUExNjEtREVDQTEzMjM4MzA3JigDVQE3M0I5NjcxQi1FM0U2LTRCNEMtQUYxOC1CNzIyRTBFOTI2NEMhKANVATcxNTNDMzdELTZDQkItNDU3Qi04MEI0LTAxNUNFRjgxQTcwRDcoA1UBNjhGNzc5RjYtMjAwMi00RTkxLUJFNzUtNUZDQkFGNTM1OTMxHigDVQE2M0RDMjZEMS00REJDLTRDNjMtOUY0Mi0wMkJENzIwN0FDQTkzKANVATYzODdCNzI3LTdFQkItNEI2OS1CRUVCLUI0NEZBRTczOUIxQj8oA1UBNTkzODNGMkUtRDVCRS00NzVDLUE1NjktNjBFOTRCODA3N0RBNCgDVQE1Njk2ODk0RS1ENTlCLTRBRkEtQUYwQS00OThENjAyNjk1MTkFKANVATU1ODUxOUI4LTg1QTMtNEI2OC05NjI5LTE2NUMzQThFOUUxREMoA1UBNTQwQTZFMUUtN0Q3Ny00Rjg4LThGNDQtMTE5NUU1MTMzQjk3ESgDVQE0RUNENTY5My1DRDkwLTRERUItOEIzNS00NkY1ODQ3QjlCQjg5KANVATRDMUU4RTI5LTAzRDItNDNBRS05MTAzLTg0QjBEMDUwREFCMwkoA1UBNEJDNUI1ODQtQzFCNC00NzdFLUFCNjMtNzk5QzlFNDIyOTlDLSgDVQE0OUIzRjdBMS1DMzU4LTQ1MTYtQjA5MS1DREJERDEwRUFGRDkTKANVATQ5QURBOTU4LUREMEYtNEZENC05QTk4LTYxNjc1MzdENDM0OBkoA1UBNDk4MDhERTktNEExNi00QkQxLTg2NzMtMTRGQTg3RjA3MkM4HCgDVQE0OEY4NkVFMi05MTYxLTQ5NTktOEVDRS1BM0U4NTM0N0Y5RjcIKANVATQ4QzZDNkQ2LUIzOUEtNDQ1NC1CN0E0LUQ4RTFBQUY2OTYyODAoA1UBNDY5QjUzMjgtODM0OC00MEY1LUE1MTgtMjIxNTI3RjQ5NEU3ICgDVQE0NDMxMTY3Ri00OEIwLTRGOTctOTE1Mi0xRjkwRDQ5OUU1MDINKANVATQyNDQxNDI4LTMzQjUtNDI5My04QkYxLTExMUIzOTg3MjA4RT4oA1UBNDBGREQ2QkQtMDYyRS00MzdGLTgyNEQtQ0RCODZBQTFFMjBENigDVQEzRTJGQUE5Ny04NEYyLTRDQkYtOENGNy1EQjc1NTFCMjlBRDcbKANVATM5MTJCREMzLTUzMTMtNDQ2Ny1BRDNCLUIyMUVCQkIyQjQyMDgoA1UBMzE3OUM4RjUtNDBGOC00NzVELUFCREQtQ0E3NEFCMjI1ODlDLygDVQEzMTNBMUI4MS0xQTUyLTQ2RDItOEJDQi05MTRGOTBBRkEzRDMxKANVATMwNEZCRDc0LTQ1ODYtNDQ3RC1CQzQ2LTUyOEU0NThBMzg3RQQoA1UBMkIzNjVCQzMtMDk5Mi00Q0Q1LThBQjktM0U4ODEzNEIxRDIxHygDVQEyNzE3NEE4MC0yQjFELTRBMzktQjkzQi1BRDFBQUI5MDlFMzcVKANVATI1MjdBQTYyLTMwMjMtNEM4Ny04QUEyLTA0NTJCQUMyRTc5OTsoA1UBMjA1NkMzOTctQTc5Mi00RjgyLTk2NzgtOUI1RDZBNkI0ODU0AigDVQExQTE4QjczQi1CMjQ0LTQ1NjktQTU3NS0wNDAzMTlEOTRENjJFKANVATEyODA3MjMzLTExMTAtNEMzMS04MjkxLTEyNzMxMTUxMTVCRC4oA1UBMTBCM0RBNjctQzVDOC00QjU1LThFMzMtQTg3RDQwM0NBQkFCOigDVQExMDBBQTU0Mi1CRUQ1LTQwQUEtQUMyNC1FQURGRDNCOUUzMjIPKANVATBERTczMjYyLTY2QjctNEVBMy04MzVDLTMzNkM0QUNCQzc5NAsoA1UBMENFODY0N0QtNEU1OS00QzkwLTg1ODItRDZGRjlCOUNBOTlGKigDVQEwOEM5MDU3Ny05QTc1LTRFRTgtQUY0RS03MzMxOEIzOEYzQUVEDQAAACQAZwAPkQ8iDrMORA3VDWYM9wyIDBkLqgs7CswKXQnuCYAJEQiiCDMHxAdVBuYGdwYIBZkFKgS7BEwD3QNvAwACkQIjAbQBRQDWAGcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAG0kBVVBOzNENkUzNTVCMi0zRjc0LTQwM0ItQTU1Qy01NUEwMUMxMDNERDVUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTAuNzU2MDAwMS0wMS0wMSAwMDowMDowMG0jBVVBOzNBOTRGRDg5Qy0yMTM1LTQxN0YtQUEzNi0wQjExRUVDMDMxNjZUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTAuNTU5MDAwMS0wMS0wMSAwMDowMDowMG0iBVVBOzNDOUQ0MzhCQy04QzU3LTQxMUQtOUVGMC04RDBFREY2NzYyN0ZUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTAuMzgxMDAwMS0wMS0wMSAwMDowMDowMG0hBVVBOzM3M0I5NjcxQi1FM0U2LTRCNEMtQUYxOC1CNzIyRTBFOTI2NENUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTAuMjA4MDAwMS0wMS0wMSAwMDowMDowMGwgBVVBOTM0NjlCNTMyOC04MzQ4LTQwRjUtQTUxOC0yMjE1MjdGNDk0RTdUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTAuMDIwMDAxLTAxLTAxIDAwOjAwOjAwbR8FVUE7MzJCMzY1QkMzLTA5OTItNENENS04QUI5LTNFODgxMzRCMUQyMVRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowOS44NTcwMDAxLTAxLTAxIDAwOjAwOjAwbR4FVUE7MzY4Rjc3OUY2LTIwMDItNEU5MS1CRTc1LTVGQ0JBRjUzNTkzMVRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowOS42NjkwMDAxLTAxLTAxIDAwOjAwOjAwbB0FVUE5M0I3QjE0MzJELUVDNTMtNDExRi05MzQ4LTNGQTMxNjVCNzJFMlRlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzowOS40OTAwMDEtMDEtMDEgMDA6MDA6MDBtHAVVQTszNDk4MDhERTktNEExNi00QkQxLTg2NzMtMTRGQTg3RjA3MkM4VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA3LjUyOTAwMDEtMDEtMDEgMDA6MDA6MDBtGwVVQTszM0UyRkFBOTctODRGMi00Q0JGLThDRjctREI3NTUxQjI5QUQ3VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA3LjM1NjAwMDEtMDEtMDEgMDA6MDA6MDBtGgVVQTszQ0VBRkZCNUUtM0I3MC00NjM2LTg4REItQjM3NjY5NkYxMzRGVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA3LjIwODAwMDEtMDEtMDEgMDA6MDA6MDBtGQVVQTszNDlBREE5NTgtREQwRi00RkQ0LTlBOTgtNjE2NzUzN0Q0MzQ4VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA3LjA1MTAwMDEtMDEtMDEgMDA6MDA6MDBtGAVVQTszODhEOTk5MUMtNUUyMy00MjQ1LTlCODMtRTY3QUE2NDZBQjZEVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA2Ljg3MjAwMDEtMDEtMDEgMDA6MDA6MDBtFwVVQTszOTlENjQ4MkYtNUM5RC00RUMwLTlDMkQtNEU1MjQ2OTRCNkYxVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA2LjcyMjAwMDEtMDEtMDEgMDA6MDA6MDBtFgVVQTszQjE4RDk2MjQtNjIxOC00OUNFLTg4OUItREJFOTgxRTU4QTU5VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA2LjUxOTAwMDEtMDEtMDEgMDA6MDA6MDBtFQVVQTszMjcxNzRBODAtMkIxRC00QTM5LUI5M0ItQUQxQUFCOTA5RTM3VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA2LjM1MzAwMDEtMDEtMDEgMDA6MDA6MDBtFAVVQTszRTkxMTc3QTgtNTg1OC00QzRBLThDRDAtQTVDNjM0RkQ0REIyVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA2LjE1OTAwMDEtMDEtMDEgMDA6MDA6MDBtEwVVQTszNDlCM0Y3QTEtQzM1OC00NTE2LUIwOTEtQ0RCREQxMEVBRkQ5VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA1Ljk3MTAwMDEtMDEtMDEgMDA6MDA6MDBtEgVVQTszQkFGM0I3ODUtM0Y5Ni00MUQwLTk5NzMtMDdFRkVEQkM0RkNEVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA1LjgyMjAwMDEtMDEtMDEgMDA6MDA6MDBtEQVVQTszNTQwQTZFMUUtN0Q3Ny00Rjg4LThGNDQtMTE5NUU1MTMzQjk3VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA1LjYyNzAwMDEtMDEtMDEgMDA6MDA6MDBtEAVVQTszRkE5MTY0NTYtMjk1Mi00NjlGLTk0OTgtQ0EzNzdDMkRCRTU2VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA1LjQ0NDAwMDEtMDEtMDEgMDA6MDA6MDBsDwVVQTkzMTAwQUE1NDItQkVENS00MEFBLUFDMjQtRUFERkQzQjlFMzIyVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjA1LjI3MDAwMS0wMS0wMSAwMDowMDowMG0OBVVBOzNDNzgzRUYxQi1GRkRDLTQ3RDYtQjJENy1DRkVCOTlBMEQ3NTVUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDUuMDk5MDAwMS0wMS0wMSAwMDowMDowMG0NBVVBOzM0NDMxMTY3Ri00OEIwLTRGOTctOTE1Mi0xRjkwRDQ5OUU1MDJUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDQuOTI4MDAwMS0wMS0wMSAwMDowMDowMG0MBVVBOzM5RUU0OTA5QS1CQjkwLTQ2OTQtOTdGRS1BQUE2OEYzN0NBRjhUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDQuNzY0MDAwMS0wMS0wMSAwMDowMDowMG0LBVVBOzMwREU3MzI2Mi02NkI3LTRFQTMtODM1Qy0zMzZDNEFDQkM3OTRUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDQuNTkyMDAwMS0wMS0wMSAwMDowMDowMG0KBVVBOzNENjFEOEQ1NS0zMEM2LTREOTItOTQyQi1EREQzMzFGRjJGRDNUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDQuNDMzMDAwMS0wMS0wMSAwMDowMDowMG0JBVVBOzM0QzFFOEUyOS0wM0QyLTQzQUUtOTEwMy04NEIwRDA1MERBQjNUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDQuMjY4MDAwMS0wMS0wMSAwMDowMDowMG0IBVVBOzM0OEY4NkVFMi05MTYxLTQ5NTktOEVDRS1BM0U4NTM0N0Y5RjdUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDQuMDk4MDAwMS0wMS0wMSAwMDowMDowMG0HBVVBOzM5QzhFQjJBNC1BMTgyLTQ2MzEtQTA3Mi02MTBBQzZBNTRGODVUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDMuOTMxMDAwMS0wMS0wMSAwMDowMDowMG0GBVVBOzNDMjI1NUYwNC1GNEY4LTQ0NDYtQjI0RC05MzJEQkYzOEY2RjlUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDMuNzcyMDAwMS0wMS0wMSAwMDowMDowMG0FBVVBOzM1Njk2ODk0RS1ENTlCLTRBRkEtQUYwQS00OThENjAyNjk1MTlUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDEuNDY0MDAwMS0wMS0wMSAwMDowMDowMG0EBVVBOzMzMDRGQkQ3NC00NTg2LTQ0N0QtQkM0Ni01MjhFNDU4QTM4N0VUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDEuMjgyMDAwMS0wMS0wMSAwMDowMDowMG0DBVVBOzNGMDIwNDBGRi02QzRDLTRCRUMtQUQwNi04OTc4RDgwMjhBRTRUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDAuOTQ4MDAwMS0wMS0wMSAwMDowMDowMG0CBVVBOzMyMDU2QzM5Ny1BNzkyLTRGODItOTY3OC05QjVENkE2QjQ4NTRUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MDAuNTkyMDAwMS0wMS0wMSAwMDowMDowMG0BBVVBOzNDNzU3NzZFRi1FNDE0LTQ0RTktODUxRi03OUQ0QjQ0QkY1QjNUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzI6NTMuMDI1MDAwMS0wMS0wMSAwMDowMDowMA0AAAAhAbQAD5EPIg6zDkQN1Q1mDPcMiAwaC6wLPQrOCl8J8AmBCRIIowg0B8UHVgbnBngGCQWaBSsEvARNA98DcAMBApICIwG0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABtRQVVQTszMUExOEI3M0ItQjI0NC00NTY5LUE1NzUtMDQwMzE5RDk0RDYyVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjE5Ljk0NTAwMDEtMDEtMDEgMDA6MDA6MDBtRAVVQTszMDhDOTA1NzctOUE3NS00RUU4LUFGNEUtNzMzMThCMzhGM0FFVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjE5Ljc4NzAwMDEtMDEtMDEgMDA6MDA6MDBtQwVVQTszNTU4NTE5QjgtODVBMy00QjY4LTk2MjktMTY1QzNBOEU5RTFEVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjE5LjYzNDAwMDEtMDEtMDEgMDA6MDA6MDBtQgVVQTszOTg0QUQ3NzUtMzQxNy00QzBDLTlEQkQtOTY0MTAyMTc2REM2VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjE5LjQ2MjAwMDEtMDEtMDEgMDA6MDA6MDBtQQVVQTszRThGMTA3NzUtNzNGQy00ODgwLUEzQzAtM0RFNzkwNkMzNkI2VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjE5LjI4ODAwMDEtMDEtMDEgMDA6MDA6MDBsQAVVQTkzQTI5MjhERDUtMkJCOS00Q0NDLThGMEMtRTZENUE5MkZDQTE1VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjE5LjEyMDAwMS0wMS0wMSAwMDowMDowMG0/BVVBOzM2Mzg3QjcyNy03RUJCLTRCNjktQkVFQi1CNDRGQUU3MzlCMUJUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTguOTQ1MDAwMS0wMS0wMSAwMDowMDowMG0+BVVBOzM0MjQ0MTQyOC0zM0I1LTQyOTMtOEJGMS0xMTFCMzk4NzIwOEVUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTguNzcyMDAwMS0wMS0wMSAwMDowMDowMG09BVVBOzNEOUY1QzdFQi1CQjZGLTREQUItOTc1Qi1BRUM4NzEzRTVDRkRUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTguNTg3MDAwMS0wMS0wMSAwMDowMDowMG08BVVBOzNFQzJGMjZCNi1FMkFBLTQ2Q0UtODkzOS01MEI0M0NDRkQ4NjlUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTguNDA2MDAwMS0wMS0wMSAwMDowMDowMG07BVVBOzMyNTI3QUE2Mi0zMDIzLTRDODctOEFBMi0wNDUyQkFDMkU3OTlUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTguMjM2MDAwMS0wMS0wMSAwMDowMDowMG06BVVBOzMxMEIzREE2Ny1DNUM4LTRCNTUtOEUzMy1BODdENDAzQ0FCQUJUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTYuODYyMDAwMS0wMS0wMSAwMDowMDowMG05BVVBOzM0RUNENTY5My1DRDkwLTRERUItOEIzNS00NkY1ODQ3QjlCQjhUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTYuNzA0MDAwMS0wMS0wMSAwMDowMDowMG04BVVBOzMzOTEyQkRDMy01MzEzLTQ0NjctQUQzQi1CMjFFQkJCMkI0MjBUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTYuNTMzMDAwMS0wMS0wMSAwMDowMDowMG03BVVBOzM3MTUzQzM3RC02Q0JCLTQ1N0ItODBCNC0wMTVDRUY4MUE3MERUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTYuMzgzMDAwMS0wMS0wMSAwMDowMDowMG02BVVBOzM0MEZERDZCRC0wNjJFLTQzN0YtODI0RC1DREI4NkFBMUUyMERUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTMuOTEzMDAwMS0wMS0wMSAwMDowMDowMG01BVVBOzNGQjdBRjcxQy1DNDk4LTRGQUItODRCMC04QzhFOTkwNjEyOEFUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTMuNzY1MDAwMS0wMS0wMSAwMDowMDowMG00BVVBOzM1OTM4M0YyRS1ENUJFLTQ3NUMtQTU2OS02MEU5NEI4MDc3REFUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTMuNjA1MDAwMS0wMS0wMSAwMDowMDowMG0zBVVBOzM2M0RDMjZEMS00REJDLTRDNjMtOUY0Mi0wMkJENzIwN0FDQTlUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTMuNDM0MDAwMS0wMS0wMSAwMDowMDowMG0yBVVBOzNENTQ0MjExMS02MzMyLTQwNDMtODdBQy00Q0ZBQTM2OTU3ODJUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTMuMjUyMDAwMS0wMS0wMSAwMDowMDowMG0xBVVBOzMzMTNBMUI4MS0xQTUyLTQ2RDItOEJDQi05MTRGOTBBRkEzRDNUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTMuMDY1MDAwMS0wMS0wMSAwMDowMDowMG0wBVVBOzM0OEM2QzZENi1CMzlBLTQ0NTQtQjdBNC1EOEUxQUFGNjk2MjhUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTIuODg2MDAwMS0wMS0wMSAwMDowMDowMG0vBVVBOzMzMTc5QzhGNS00MEY4LTQ3NUQtQUJERC1DQTc0QUIyMjU4OUNUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTIuNzA2MDAwMS0wMS0wMSAwMDowMDowMGwuBVVBOTMxMjgwNzIzMy0xMTEwLTRDMzEtODI5MS0xMjczMTE1MTE1QkRUZXN0IGZhY3RvcnkgaW5zZXJ0IFNRTGl0ZTIwMjQtMDYtMjQgMTI6MzM6MTIuNTIwMDAxLTAxLTAxIDAwOjAwOjAwbC0FVUE5MzRCQzVCNTg0LUMxQjQtNDc3RS1BQjYzLTc5OUM5RTQyMjk5Q1Rlc3QgZmFjdG9yeSBpbnNlcnQgU1FMaXRlMjAyNC0wNi0yNCAxMjozMzoxMi4zNzAwMDEtMDEtMDEgMDA6MDA6MDBtLAVVQTszODFDMEZDQjYtOUVCOC00QjM3LUFGOEMtNDQzRjA4NjA3OUZGVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjEyLjE3MzAwMDEtMDEtMDEgMDA6MDA6MDBtKwVVQTszOEE1NjgzNzItRjBGMC00RTAxLUFGRTEtRTY1MjlCNUU5RTA0VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjExLjk4ODAwMDEtMDEtMDEgMDA6MDA6MDBtKgVVQTszMENFODY0N0QtNEU1OS00QzkwLTg1ODItRDZGRjlCOUNBOTlGVGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjExLjc5OTAwMDEtMDEtMDEgMDA6MDA6MDBtKQVVQTszRUIwRkZDRDgtMjhDNS00MDVFLThGOTMtMTEzQUM3RkRGMDU3VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjExLjYyNDAwMDEtMDEtMDEgMDA6MDA6MDBtKAVVQTszREVEQUQxQzctMEM5Ny00NjQwLUFCOTktMkUxQzc3QzQ3RTE4VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjExLjQ0NDAwMDEtMDEtMDEgMDA6MDA6MDBtJwVVQTszRkIwNzVBQ0UtRjg2Ni00Qzk0LThGQ0YtRUMzQzI2NzRFQTg4VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjExLjI2NjAwMDEtMDEtMDEgMDA6MDA6MDBtJgVVQTszNzlDRUIzRDAtREE0QS00MEYyLUExNjEtREVDQTEzMjM4MzA3VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjExLjA4NjAwMDEtMDEtMDEgMDA6MDA6MDBtJQVVQTszRUNDRTFDMzQtNEE0OC00RTlELUE4NDMtQ0Y4N0ZCOEVDNUQ5VGVzdCBmYWN0b3J5IGluc2VydCBTUUxpdGUyMDI0LTA2LTI0IDEyOjMzOjEwLjkxNDAwMDEtMDEtMDEgMDA6MDA6MDA=";

        await ImportDbContextFromBase64Async(_dbContext, base64String);
    }

    private async Task ImportDbContextFromBase64Async(AliasClientDbContext dbContext, string base64String)
    {
        var bytes = Convert.FromBase64String(base64String);
        var tempFileName = Path.GetTempFileName();
        await File.WriteAllBytesAsync(tempFileName, bytes);

        using (var connection = new SqliteConnection(dbContext.Database.GetDbConnection().ConnectionString))
        {
            await connection.OpenAsync();
            using (var command = connection.CreateCommand())
            {
                // Drop all tables in the original database
                command.CommandText = @"
                    SELECT 'DELETE FROM ' || name || ';'
                    FROM sqlite_master
                    WHERE type = 'table' AND name NOT LIKE 'sqlite_%';";
                var dropTableCommands = new List<string>();
                using (var reader = await command.ExecuteReaderAsync())
                {
                    while (await reader.ReadAsync())
                    {
                        dropTableCommands.Add(reader.GetString(0));
                    }
                }

                foreach (var dropTableCommand in dropTableCommands)
                {
                    command.CommandText = dropTableCommand;
                    await command.ExecuteNonQueryAsync();
                }

                // Attach the imported database and copy tables
                command.CommandText = "ATTACH DATABASE @fileName AS importDb";
                command.Parameters.Add(new SqliteParameter("@fileName", tempFileName));
                await command.ExecuteNonQueryAsync();

                command.CommandText = @"
                    SELECT 'INSERT INTO main.' || name || ' SELECT * FROM importDb.' || name || ';'
                    FROM sqlite_master
                    WHERE type = 'table' AND name NOT LIKE 'sqlite_%';";
                var tableInsertCommands = new List<string>();
                using (var reader = await command.ExecuteReaderAsync())
                {
                    while (await reader.ReadAsync())
                    {
                        tableInsertCommands.Add(reader.GetString(0));
                    }
                }

                foreach (var tableInsertCommand in tableInsertCommands)
                {
                    command.CommandText = tableInsertCommand;
                    await command.ExecuteNonQueryAsync();
                }

                command.CommandText = "DETACH DATABASE importDb";
                await command.ExecuteNonQueryAsync();
            }
        }

        File.Delete(tempFileName);
    }
}
